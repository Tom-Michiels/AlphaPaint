#!/usr/bin/env python3
import random
import sys
import traceback
from alphapaint import AlphaPaint, AlphaPaintError

def log(msg):
    """Log naar stderr (zichtbaar in daemon log)."""
    print(f"[pentest] {msg}", file=sys.stderr, flush=True)

# Configuratie
NUM_PENS = 5
CELL_SIZE = 15      # Grid cel grootte in mm
SHAPE_SIZE = 10     # Vorm grootte in mm
MIN_SHAPES_PER_PEN = 1
MAX_SHAPES_PER_PEN = 5

def draw_cross(ap, center_x, center_y, size):
    """Teken een kruisje op canvas coordinaten."""
    half = size / 2
    # Lijn 1: links-onder naar rechts-boven
    ap.move_to(center_x - half, center_y - half)
    ap.pen_down()
    ap.draw_to(center_x + half, center_y + half)
    ap.pen_up_fast()
    # Lijn 2: links-boven naar rechts-onder
    ap.move_to(center_x - half, center_y + half)
    ap.pen_down()
    ap.draw_to(center_x + half, center_y - half)
    ap.pen_up_fast()


def draw_square(ap, center_x, center_y, size):
    """Teken een vierkant op canvas coordinaten."""
    half = size / 2
    ap.move_to(center_x - half, center_y - half)
    ap.pen_down()
    ap.draw_to(center_x + half, center_y - half)
    ap.draw_to(center_x + half, center_y + half)
    ap.draw_to(center_x - half, center_y + half)
    ap.draw_to(center_x - half, center_y - half)
    ap.pen_up_fast()


def draw_circle(ap, center_x, center_y, size):
    """Teken een cirkel op canvas coordinaten."""
    radius = size / 2
    # Start rechts van centrum
    ap.move_to(center_x + radius, center_y)
    ap.pen_down()
    # Eerste halve cirkel (boven)
    ap.draw_arc(center_x - radius, center_y, -radius, 0, clockwise=True)
    # Tweede halve cirkel (onder)
    ap.draw_arc(center_x + radius, center_y, radius, 0, clockwise=True)
    ap.pen_up_fast()


def draw_random_shape(ap, center_x, center_y, size):
    """Teken een willekeurige vorm (kruisje, vierkant of cirkel)."""
    shape = random.choice(['cross', 'square', 'circle'])
    log(f"Drawing {shape} at ({center_x}, {center_y})")
    if shape == 'cross':
        draw_cross(ap, center_x, center_y, size)
    elif shape == 'square':
        draw_square(ap, center_x, center_y, size)
    else:
        draw_circle(ap, center_x, center_y, size)

def main():
    log("Start pentest - grid met willekeurige vormen")
    try:
        with AlphaPaint() as ap:
            # Bereken grid op basis van canvas grootte
            canvas = ap.canvas
            cols = int(canvas.width // CELL_SIZE)
            rows = int(canvas.height // CELL_SIZE)
            log(f"Canvas: {canvas.width}x{canvas.height}mm, Grid: {cols}x{rows} cellen")

            # Maak lijst van alle grid posities (center x, center y)
            cells = []
            for row in range(rows):
                for col in range(cols):
                    cx = col * CELL_SIZE + CELL_SIZE / 2
                    cy = row * CELL_SIZE + CELL_SIZE / 2
                    cells.append((cx, cy))

            # Shuffle voor willekeurige volgorde
            random.shuffle(cells)
            log(f"Totaal {len(cells)} cellen te vullen")

            cell_index = 0
            pen_round = 0

            # Vul ALLE cellen door pennen cyclisch te hergebruiken
            while cell_index < len(cells):
                pen_index = pen_round % NUM_PENS
                log(f"=== Pen {pen_index} (cell {cell_index}/{len(cells)}) ===")
                ap.pickup_pen(pen_index)

                # Teken 1-5 vormen met deze pen
                shapes_this_pen = random.randint(MIN_SHAPES_PER_PEN, MAX_SHAPES_PER_PEN)
                log(f"Tekent {shapes_this_pen} vormen")

                for _ in range(shapes_this_pen):
                    if cell_index >= len(cells):
                        break
                    cx, cy = cells[cell_index]
                    draw_random_shape(ap, cx, cy, SHAPE_SIZE)
                    cell_index += 1

                # Pen volledig omhoog voordat we terugzetten
                ap.pen_up()
                ap.return_pen(pen_index)
                pen_round += 1

            # Naar home positie
            log("Naar home positie")
            ap.move_to_machine(x=0, y=0)

        log(f"Pentest voltooid - {cell_index} vormen getekend")
    except AlphaPaintError as e:
        log(f"AlphaPaintError: {e} (code={e.code})")
        traceback.print_exc(file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        log(f"Exception: {e}")
        traceback.print_exc(file=sys.stderr)
        sys.exit(1)

if __name__ == '__main__':
    main()
